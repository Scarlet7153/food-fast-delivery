# ============================================
# XÃ“A VÃ€ BUILD Láº I Tá»ª Äáº¦U
# ============================================

Write-Host "`nğŸ—‘ï¸  BÆ¯á»šC 1: XÃ³a Kubernetes resources..." -ForegroundColor Red
kubectl delete all --all -n ffdd 2>$null
kubectl delete configmap --all -n ffdd 2>$null
kubectl delete secret --all -n ffdd 2>$null
kubectl delete pvc --all -n ffdd 2>$null
kubectl delete namespace ffdd 2>$null
Start-Sleep -Seconds 5

Write-Host "`nğŸ—‘ï¸  BÆ¯á»šC 2: XÃ³a Docker images..." -ForegroundColor Red
docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "ffdd-|food-fast-delivery-" | ForEach-Object { docker rmi $_ -f 2>$null }
docker image prune -f
docker container prune -f

Write-Host "`nğŸ”¨ BÆ¯á»šC 3: Build Docker images..." -ForegroundColor Cyan
rem use the script directory as project root
Push-Location $PSScriptRoot
docker-compose build --no-cache

Write-Host "`nğŸ·ï¸  BÆ¯á»šC 4: Tag images..." -ForegroundColor Cyan
docker tag food-fast-delivery-api-gateway:latest ffdd-api-gateway:latest 2>$null
docker tag food-fast-delivery-user-service:latest ffdd-user-service:latest 2>$null
docker tag food-fast-delivery-restaurant-service:latest ffdd-restaurant-service:latest 2>$null
docker tag food-fast-delivery-order-service:latest ffdd-order-service:latest 2>$null
docker tag food-fast-delivery-payment-service:latest ffdd-payment-service:latest 2>$null
docker tag food-fast-delivery-drone-service:latest ffdd-drone-service:latest 2>$null
docker tag food-fast-delivery-client:latest ffdd-client:latest 2>$null

Write-Host "`nğŸ“¦ BÆ¯á»šC 5: Deploy Kubernetes..." -ForegroundColor Green

# Táº¡o namespace
kubectl create namespace ffdd

# Deploy ConfigMap vÃ  Secrets
Write-Host "`nğŸ“ Deploying ConfigMap and Secrets..." -ForegroundColor Yellow
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secrets.yaml

# Deploy MongoDB vÃ  Ä‘á»£i sáºµn sÃ ng
Write-Host "`nğŸƒ Deploying MongoDB..." -ForegroundColor Yellow
kubectl apply -f k8s/mongodb.yaml
kubectl wait --for=condition=ready pod -l app=mongodb -n ffdd --timeout=120s

# Deploy Services
Write-Host "`nğŸš€ Deploying Services..." -ForegroundColor Yellow
kubectl apply -f k8s/user-service.yaml
kubectl apply -f k8s/restaurant-service.yaml
kubectl apply -f k8s/order-service.yaml
kubectl apply -f k8s/payment-service.yaml
kubectl apply -f k8s/drone-service.yaml
kubectl apply -f k8s/api-gateway.yaml
kubectl apply -f k8s/client.yaml

# Deploy Monitoring - Pháº£i deploy ConfigMaps trÆ°á»›c khi deploy Grafana
Write-Host "`nğŸ“Š Deploying Monitoring Stack..." -ForegroundColor Yellow
kubectl apply -f k8s/monitoring/prometheus-config.yaml
kubectl apply -f k8s/monitoring/prometheus.yaml
kubectl apply -f k8s/monitoring/prometheus-pushgateway.yaml

# Deploy Grafana ConfigMaps TRÆ¯á»šC khi deploy Grafana (quan trá»ng!)
Write-Host "`nğŸ“‹ Deploying Grafana ConfigMaps..." -ForegroundColor Yellow
kubectl apply -f k8s/monitoring/grafana-dashboard.yaml
kubectl apply -f k8s/monitoring/grafana-test-dashboard.yaml

# Deploy Grafana sau khi ConfigMaps Ä‘Ã£ sáºµn sÃ ng
Write-Host "`nğŸ“ˆ Deploying Grafana..." -ForegroundColor Yellow
kubectl apply -f k8s/monitoring/grafana.yaml

Write-Host "`nâ³ Äá»£i services khá»Ÿi Ä‘á»™ng..." -ForegroundColor Yellow
Start-Sleep -Seconds 15

Write-Host "`nâœ… HOÃ€N Táº¤T! Kiá»ƒm tra status:" -ForegroundColor Green
Write-Host "`nğŸ“Š Pod Status:" -ForegroundColor Cyan
kubectl get pods -n ffdd

Write-Host "`nğŸŒ Services:" -ForegroundColor Cyan
kubectl get svc -n ffdd

Write-Host "`nğŸ’¡ Access URLs:" -ForegroundColor Yellow
Write-Host "   - Grafana: http://localhost:31000 (admin/admin123)" -ForegroundColor Green
Write-Host "   - Prometheus: http://localhost:30090" -ForegroundColor Green
Write-Host "   - Pushgateway: http://localhost:30091" -ForegroundColor Green
Write-Host "   - API Gateway: http://localhost:30001" -ForegroundColor Green


-------------test-------------------------

# Set Pushgateway URL
$env:PROMETHEUS_PUSHGATEWAY_URL="http://localhost:9091"

# Cháº¡y tests cho tá»«ng service
cd services\user-service
npm test
cd ..\..

cd services\restaurant-service
npm test
cd ..\..

cd services\payment-service
npm test
cd ..\..

cd services\order-service
npm test
cd ..\..

cd services\drone-service
npm test
cd ..\..

cd services\api-gateway
npm test
cd ..\..


Pop-Location


